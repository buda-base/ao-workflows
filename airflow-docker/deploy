#!/usr/bin/env bash
#
#
# Create a deployment directory for the airflow docker compose service

#
# also cobbled from bdrc-docker.sh
init_env() {
  for d in $(seq 0 99); do
    todo=${1}/Archive$(($d / 25))/$(printf "%02d" $d)
    mkdir -p $todo || exit 1
    chmod -R 777 $todo
  done
}

OPTIONS=$(getopt -o s:d: --long source,dest -- "$@")

while true; do # Parse command line options
  case "$1" in
  -s | --source)
    export SRC=$2
    shift 2
    ;;
  -d | --dest)
    export DEPLOY=$2
    shift 2
    ;;

  --)
    shift
    break
    ;;
  *)
    break
    ;;
  esac
done

if [[ -z $SRC ]] || [[ -z $DEPLOY ]]; then
  echo no args. bye
  exit 1
fi

if [[ ! -d $DEPLOY ]]; then
  mkdir $DEPLOY
  for DD in $DEPLOY/dags $DEPLOY/logs $DEPLOY/config $DEPLOY/plugins; do
    mkdir -p $DD
    chmod 777 $DD
  done
  #
  # Set up mount points
  init_env $DEPLOY
fi

cp $SRC/bdrc-docker-compose.yml $DEPLOY/docker-compose.yaml
cp -r $SRC/dags ${DEPLOY}

# Borrowed from bdrc-docker.sh
export SECRETS=$DEPLOY/.docker-secrets
mkdir -p "${SECRETS}"
cp -v ~/.config/bdrc/docker/* "${SECRETS}" || exit 1
./extract-section.pl ~/.aws/credentials default >${SECRETS}/aws-credentials || exit 1
# chmod u-w "${SECRETS}"

cat <<EOF >$DEPLOY/.env
SECRETS=.docker-secrets
BIN=
COMPOSE_BUILD_DIR=.
ARCH_ROOT=.
SYNC_ACCESS_UID=1001
EOF

# They say this is a BUILD image arg, not a runtime arg
# AIRFLOW_UID=1000
# AIRFLOW_GID=0
